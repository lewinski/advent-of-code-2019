<?php

require_once __DIR__.'/lib/intcode.php';

$input = file_get_contents(__DIR__.'/../input/17.txt');

$computer = new \Intcode\Computer($input);
$computer->run();
$output = $computer->output(0);
$output = array_map('chr', $output);
$map = implode('', $output);
echo "$map";

$length = array_search("\n", $output) + 1;

$calibration = 0;
$scaffold = ["#", "v", "^", "<", ">"];
for ($i = 0; $i < count($output); $i++) {
    $cross = [$i - $length, $i - 1, $i, $i + 1, $i + $length];
    foreach ($cross as $pos) {
        if (!in_array($output[$pos], $scaffold)) {
            continue 2;
        }
    }

    $x = $i % $length;
    $y = intdiv($i, $length);
    $calibration += $x * $y;
}
echo "day17 part1 = $calibration\n";

/*

....#########......................................
....#.......#......................................
....#.......#......................................
....#.......#......................................
....#.......#......................................
....#.......#......................................
....###########....................................
............#.#....................................
............#.#....................................
............#.#....................................
............#######................................
..............#...#................................
..............#...#.....###########.........#######
..............#...#.....#.........#.........#.....#
..............#...#.....#.........#.........#.....#
..............#...#.....#.........#.........#.....#
..........###########...#.........#.........#.....#
..........#...#...#.#...#.........#.........#.....#
..........#...###########.........#.........#.....#
..........#.......#.#.............#.........#.....#
......#############.#.............#...#############
......#...#.........#.............#...#.....#......
###########.........#...........#############......
#.....#.............#...........#.#...#............
#.....#.............#...........#.#######..........
#.....#.............#...........#.....#.#..........
#.....#.............#.....^############.#..........
#.....#.............#...........#.......#..........
#.....#.............#############.......#..........
#.....#.................................#..........
#######.................................#..........
........................................#..........
........................................#..........
........................................#..........
........................................#..........
........................................#..........
............................#############..........
............................#......................
............................#......................
............................#......................
............................#......................
............................#......................
............................#......................
............................#......................
............................#......................
............................#......................
............................#######................
..................................#................
..................................#................
..................................#................
..................................#................
..................................#................
..................................#................
..................................#................
..................................#................
..................................#................
..................................#................

full program: R,12,L,6,R,12,L,8,L,6,L,10,R,12,L,6,R,12,R,12,L,10,L,6,R,10,L,8,L,6,L,10,R,12,L,10,L,6,R,10,L,8,L,6,L,10,R,12,L,10,L,6,R,10,R,12,L,6,R,12,R,12,L,10,L,6,R,10

main: A,B,A,C,B,C,B,C,A,C
A: R,12,L,6,R,12
B: L,8,L,6,L,10
C: R,12,L,10,L,6,R,10

*/

$computer = new \Intcode\Computer($input);
$input = "A,B,A,C,B,C,B,C,A,C\nR,12,L,6,R,12\nL,8,L,6,L,10\nR,12,L,10,L,6,R,10\nn\n";
$computer->poke(0, 2);
$computer->input(array_map('ord', str_split($input)));
$computer->run();
$output = $computer->output(0);
$dust = array_pop($output);
echo "day17 part2 = $dust\n";
